package org.opentestsystem.ap.tms.repository;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.opentestsystem.ap.common.exception.SystemException;
import org.opentestsystem.ap.tms.model.TestPackage;
import org.opentestsystem.ap.tms.model.TestPackageEntity;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.UUID;

@Component
class TestPackageRowMapper implements RowMapper<TestPackageEntity> {
    private final ObjectMapper mapper;

    public TestPackageRowMapper(final ObjectMapper mapper) {
        this.mapper = mapper;
    }

    @Override
    public TestPackageEntity mapRow(final ResultSet row, final int i) throws SQLException {
        return TestPackageEntity.builder()
            .id(UUID.fromString(row.getString("id")))
            .beingCreated(row.getBoolean("is_being_created"))
            .packageId(row.getString("package_id"))
            .locked(row.getBoolean("locked"))
            .testPackage(parse(row.getString("test_package_json")))
            .insertedBy(row.getString("inserted_by"))
            .insertedDate(row.getTimestamp("inserted_date").toInstant())
            .build();
    }

    private TestPackage parse(final String testPackage) {
        try {
            return mapper.readValue(testPackage, TestPackage.class);
        } catch (IOException e) {
            throw new SystemException("Failed to parse test package");
        }
    }
}
