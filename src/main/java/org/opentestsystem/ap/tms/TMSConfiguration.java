package org.opentestsystem.ap.tms;

import org.opentestsystem.ap.common.config.ItemBankProperties;
import org.opentestsystem.ap.common.datastore.DataStoreAttachmentManager;
import org.opentestsystem.ap.common.datastore.DataStoreDataManager;
import org.opentestsystem.ap.common.datastore.DataStoreItemManager;
import org.opentestsystem.ap.common.datastore.DataStoreUtility;
import org.opentestsystem.ap.common.datastore.client.AmazonClient;
import org.opentestsystem.ap.common.datastore.repository.ItemEntityRepository;
import org.opentestsystem.ap.common.datastore.repository.ItemSyncRepository;
import org.opentestsystem.ap.common.datastore.repository.WorkflowStatusRepository;
import org.opentestsystem.ap.common.datastore.repository.WorkflowStatusTransitionRepository;
import org.opentestsystem.ap.common.gitlab.GitLabItemManager;
import org.opentestsystem.ap.common.itembank.AttachmentValidator;
import org.opentestsystem.ap.common.itembank.EquationEditorRepository;
import org.opentestsystem.ap.common.management.ItemManager;
import org.opentestsystem.ap.common.management.ItemManagerEventProducer;
import org.opentestsystem.ap.common.repository.ItemRepository;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableScheduling;

@EnableScheduling
@Configuration
public class TMSConfiguration {
    private final ItemBankProperties itemBankProperties;

    public TMSConfiguration(ItemBankProperties itemBankProperties) {
        this.itemBankProperties = itemBankProperties;
    }

    @Bean
    @ConditionalOnMissingBean
    public AmazonClient amazonClient() {
        return new AmazonClient(itemBankProperties);
    }

    @Bean
    @ConditionalOnMissingBean
    public DataStoreUtility dataStoreUtility() {
        return new DataStoreUtility();
    }

    @Bean
    @ConditionalOnMissingBean
    public DataStoreAttachmentManager dataStoreAttachmentManager(AmazonClient amazonClient,
                                                                 DataStoreUtility dataStoreUtility) {
        return new DataStoreAttachmentManager(amazonClient, dataStoreUtility);
    }

    @Bean
    @ConditionalOnMissingBean
    public DataStoreDataManager dataStoreDataManager(ItemEntityRepository itemEntityRepository,
                                                     WorkflowStatusRepository workflowStatusRepository,
                                                     WorkflowStatusTransitionRepository workflowStatusTransitionRepository,
                                                     ItemSyncRepository itemSyncRepository) {
        return new DataStoreDataManager(
                this.itemBankProperties,
                itemEntityRepository,
                workflowStatusRepository,
                workflowStatusTransitionRepository,
                itemSyncRepository);
    }

    @Bean
    @ConditionalOnMissingBean
    public ItemManagerEventProducer itemManagementEventProducer(RabbitTemplate rabbitTemplate) {
        return new ItemManagerEventProducer(this.itemBankProperties, rabbitTemplate);
    }

    @Bean
    @ConditionalOnMissingBean
    public DataStoreItemManager dataStoreItemManager(DataStoreDataManager dataManager,
                                                     DataStoreAttachmentManager attachmentManager,
                                                     ItemManagerEventProducer eventProducer,
                                                     DataStoreUtility utility) {
        return new DataStoreItemManager(
                this.itemBankProperties,
                dataManager,
                attachmentManager,
                eventProducer,
                utility);
    }

    // ------------------------------------------------------------------------

    @Bean
    @ConditionalOnMissingBean
    public GitLabItemManager gitLabManager(ItemRepository itemRepository) {
        return new GitLabItemManager(this.itemBankProperties, itemRepository);
    }

    // ------------------------------------------------------------------------

    @Bean
    @ConditionalOnMissingBean
    public ItemManager itemManager(DataStoreItemManager dataStoreManager,
                                   GitLabItemManager gitLabManager,
                                   AttachmentValidator attachmentValidator,
                                   EquationEditorRepository equationEditorRepository) {
        return new ItemManager(
                dataStoreManager, gitLabManager, attachmentValidator, equationEditorRepository);
    }

    // ------------------------------------------------------------------------

}
